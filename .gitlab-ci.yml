#include:
#- template: Security/Secret-Detection.gitlab-ci.yml
#- template: Security/SAST.gitlab-ci.yml

#variables:
#SCAN_KUBERNETES_MANIFESTS: "true"

stages:
  #- test
  - build
  - deploy
  - github

Build:
  stage: build
  image: quay.io/buildah/stable:v1.23.3
  before_script:
    - buildah login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" $CI_REGISTRY
  script:
    - sed -i "s/<RECAPTCHA_SECRET>/${RECAPTCHA_SECRET}/g" email.php
    - sed -i "s/<URL>/${URL}/g" email.php
    - sed -i "s/<URL>/${URL}/g" cpd_ap.html
    - sed -i "s/<URL>/${URL}/g" homelab.html
    - sed -i "s/<URL>/${URL}/g" index.html
    - sed -i "s/[URL]/${URL}/g" sitemap.xml

    - buildah pull $CI_REGISTRY_IMAGE:$CI_COMMIT_BRANCH || true
    - buildah bud --network host -f dockerfile --cache-from $CI_REGISTRY_IMAGE:$CI_COMMIT_BRANCH -t $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA .
    - buildah push $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA
    - buildah tag $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA $CI_REGISTRY_IMAGE:$CI_COMMIT_BRANCH
    - buildah push $CI_REGISTRY_IMAGE:$CI_COMMIT_BRANCH

Deploy:
  stage: deploy
  image: ${IMAGE}
  environment: production
  script:
    - sed -i "s,<IMAGE>,${CI_REGISTRY_IMAGE},g" kubernetes/base/deployment.yaml
    - sed -i "s/<VERSION>/${CI_COMMIT_SHA}/g" kubernetes/base/deployment.yaml
    - sed -i "s/<PROJECT>/${PROJECT}/g" kubernetes/base/deployment.yaml
    - sed -i "s/<PROJECT>/${PROJECT}/g" kubernetes/base/service.yaml
    - sed -i "s/<PROJECT>/${PROJECT}/g" kubernetes/base/pipeline-sa.yaml
    - sed -i "s/<PROJECT>/${PROJECT}/g" kubernetes/overlays/okd/route.yaml
    - sed -i "s/<URL>/${URL}/g" kubernetes/overlays/okd/route.yaml
    - kubectl apply -k  kubernetes/overlays/okd

GithubFinish:
  stage: github
  image: ${IMAGE}
  script:
    - export DESCRIPTION="Completed Successfully"
    - export STATUS=success
    - kubernetes/github-status.sh
